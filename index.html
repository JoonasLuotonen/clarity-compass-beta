<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clarity Compass â€“ Public Beta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0c10; --panel:#121318; --text:#e6e6e6; --muted:#9aa3ad; --accent:#22c55e; --error:#ffb4b4; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    .card { background: var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px 18px 22px; box-shadow:0 10px 30px rgba(0,0,0,.3); }
    h1 { font-size:28px; margin:0 0 8px; }
    h2 { margin: 6px 0 8px; }
    h3 { margin: 10px 0 6px; font-size: 16px; }
    p  { color: var(--muted); margin: 6px 0 14px; }
    label { display:block; margin:10px 0 6px; font-weight:600; }
    input,select,button { font:inherit; }
    input[type=text], select {
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:#0f1014; color:#e6e6e6;
    }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .btn { border:0; border-radius:12px; padding:12px 14px; background:var(--accent); color:#051406; font-weight:700; cursor:pointer; }
    .btn.secondary{ background:#1f2937; color:#e6e6e6; }
    .muted{ color:#8a93a0; font-size:13px; }
    .hidden{ display:none; }
    .grid{ display:grid; grid-template-columns: 1.2fr 1.8fr; gap: 14px; }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    .error { color: var(--error); }
    canvas{ width:100%; height:auto; background:#0f1014; border-radius:12px; border:1px solid rgba(255,255,255,.08); }
    .section { border-top:1px solid rgba(255,255,255,.08); padding-top:12px; margin-top:12px; }
    .score-row { display:grid; grid-template-columns: 1fr 120px 46px; gap:10px; align-items:center; }
    .score-row .q { color:#d7dbe1; }
    .range { width:100%; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); color:#d7dbe1; font-size:12px; }
    .keyline { border-top:1px dashed rgba(255,255,255,.12); margin:10px 0; }
    .quickwin { padding:10px; border-radius:12px; background:#0f1014; border:1px solid rgba(255,255,255,.08); }
    .explain { font-size:13px; color:#aab3bd; margin-top:-6px; }
    @media (max-width: 820px){ .grid{ grid-template-columns:1fr; } .row{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Clarity Compass â€“ Public Beta</h1>
      <p>Paste a URL (or skip for uploads). Weâ€™ll analyze text and simple structure heuristics. Optionally, upload up to 3 screenshots to help assess visual tone. No login pages.</p>

      <div class="row">
        <div>
          <label>Context</label>
          <select id="context">
            <option value="consultancy">Consultancy / Agency</option>
            <option value="saas">SaaS / Product</option>
            <option value="outdoor">Outdoor / Physical brand</option>
          </select>
        </div>
        <div>
          <label>What are we evaluating (scope)?</label>
          <input id="scope" type="text" placeholder="e.g., Homepage, Pricing page, AA28 product page" />
        </div>
      </div>

      <label>Website URL (optional)</label>
      <input id="url" type="text" placeholder="https://example.com" />

      <label>Upload up to 3 screenshots (optional)</label>
      <input id="shots" type="file" accept="image/*" multiple />
      <p class="muted">Files are analyzed in-browser and not stored after processing (beta).</p>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
        <button class="btn" id="run">Run analysis</button>
        <button class="btn secondary" id="demo">Use demo URL</button>
      </div>
      <p id="msg" class="muted" style="margin-top:8px;"></p>
    </div>

    <div id="out" class="card hidden" style="margin-top:14px;">
      <div class="grid">
        <div>
          <h2>Radar</h2>
          <div class="muted" id="summary"></div>
          <canvas id="radar" width="420" height="420" aria-label="Radar chart"></canvas>
          <div class="keyline"></div>
          <h3>Quick Wins</h3>
          <div id="wins" class="stack"></div>
        </div>
        <div>
          <h2>Scores & Explanations</h2>
          <p class="muted" id="lens-explain">User = comprehension & navigation. Visual = cohesion & calm. Story = purpose & identity.</p>
          <div id="scoresUI" class="section"></div>
          <p class="muted" style="margin-top:8px;">You can adjust the scores above (your self-assessment). The radar & quick wins will update instantly.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    // ---------- Question copy per context (9 total: user 1â€“3, visual 4â€“6, story 7â€“9)
    const QUESTIONS = {
      consultancy: [
        // USER
        {label:"How instantly can someone tell what your company offers when they land on {scope}?", helper:"Could a new visitor describe your service in one short sentence?"},
        {label:"How easy is it for a potential client to find relevant information or services on {scope}?", helper:"Can they reach what they came for in one or two clicksâ€”without guessing?"},
        {label:"How clearly does {scope} guide a potential client toward contacting you or starting a project?", helper:"Is there a visible next stepâ€”â€œBook a callâ€, â€œGet a quoteâ€ â€” that feels natural?"},
        // VISUAL
        {label:"How consistent does the design of {scope} feelâ€”does everything look like it belongs together?", helper:"Same typography, spacing, and tone across sections."},
        {label:"How well does the visual style of {scope} communicate the quality and professionalism you deliver?", helper:"Does it look like a â‚¬50k partner or a â‚¬5k one?"},
        {label:"How comfortable and confident does {scope} feelâ€”calm and credible vs. cluttered or chaotic?", helper:"Would a client feel at ease starting a meeting here?"},
        // STORY
        {label:"How clearly does {scope} explain your value in plain, human language?", helper:"Would a client get the problem you solve and why it mattersâ€”without buzzwords?"},
        {label:"How convincingly does {scope} show the results of your work, not just what you delivered?", helper:"Are outcomes (growth, impact) visibleâ€”or just tools and methods?"},
        {label:"How much character and point of view comes through on {scope}, instead of a neutral corporate tone?", helper:"Does it sound like a real team with opinionsâ€”or a generic site?"}
      ],
      saas: [
        // USER
        {label:"How quickly can a new user see what they can achieve on {scope}?", helper:"Is the core job-to-be-done obvious in seconds?"},
        {label:"How easy is it to spot the main action on {scope} without searching?", helper:"Is the primary button clearly dominant?"},
        {label:"How naturally do messages on {scope} readâ€”human and clear vs. robotic or coded?", helper:"Error and empty states make sense at a glance."},
        // VISUAL
        {label:"How calm and focused does {scope} feel on first view?", helper:"Spacing and hierarchy guide attention; no visual noise."},
        {label:"How consistent are icons, buttons, and patterns across {scope}?", helper:"Same styles and sizes used predictably."},
        {label:"How credible does the visual tone of {scope} feel for your productâ€™s maturity?", helper:"Does it look reliable and trustworthy?"},
        // STORY
        {label:"How quickly could a visitor explain in one sentence what {scope} does?", helper:"Plain words over slogans."},
        {label:"How well does {scope} deliver on the promise from your marketing?", helper:"Expectations set vs. fulfilled."},
        {label:"How distinct does your product voice feel on {scope}?", helper:"Recognizable even without the logo."}
      ],
      outdoor: [
        // USER
        {label:"How quickly can someone tell what kind of product or activity {scope} is about?", helper:"Could a visitor guess the category in seconds (ski pack, jacket, tent)?"},
        {label:"How clearly do the visuals on {scope} show how the product is used in real life?", helper:"Gear in action, at scale, in its natural environment."},
        {label:"How clearly does {scope} communicate why the product existsâ€”the problem it solves or the benefit it gives?", helper:"What makes it worth making or buying?"},
        // VISUAL
        {label:"How well do the visuals on {scope} express the intended feelingâ€”rugged, light, premium, or technical?", helper:"Does the look signal the right attitude or performance level?"},
        {label:"How consistent are colors, typography, and imagery across {scope}?", helper:"One system vs. mixed pieces from different brands."},
        {label:"How naturally does {scope} express the place your brand belongsâ€”on the mountain, in the city, or out on the trail?", helper:"Does it feel rooted in the real environment your products are made for?"},
        // STORY
        {label:"How clearly does {scope} express what your brand stands forâ€”the bigger reason you exist beyond the products?", helper:"Can visitors sense your motivation or worldview?"},
        {label:"How strongly does {scope} make people feel somethingâ€”like inspiration, trust, or excitementâ€”beyond recognition?", helper:"Emotion or curiosity vs. purely informational."},
        {label:"How recognizable would your brand be if the logo were hidden on {scope}?", helper:"Would visuals, tone, or atmosphere still say â€œyouâ€?"},
      ],
    };

    // ---------- helpers & radar
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function renderRadar(id, scores){
      const cvs = document.getElementById(id);
      if (!cvs) return;
      const ctx = cvs.getContext('2d');
      const size = cvs.width; ctx.clearRect(0,0,size,size);

      const cx = size/2, cy = size/2, R = 160;
      const toRad = a => a * Math.PI / 180;

      ctx.strokeStyle='rgba(255,255,255,.1)';
      for(let r=R/3;r<=R;r+=R/3){ ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke(); }

      const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
      const u = avg(Object.values(scores.user))/5;
      const v = avg(Object.values(scores.visual))/5;
      const s = avg(Object.values(scores.story))/5;

      const pts = [{a:-90,r:u*R},{a:30,r:v*R},{a:150,r:s*R}]
        .map(p=>({x:cx+Math.cos(toRad(p.a))*p.r, y:cy+Math.sin(toRad(p.a))*p.r}));

      ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(pts[1].x, pts[1].y); ctx.lineTo(pts[2].x, pts[2].y);
      ctx.closePath(); ctx.fillStyle='rgba(34,197,94,.35)'; ctx.strokeStyle='rgba(34,197,94,.9)'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();

      ctx.fillStyle='#e6e6e6'; ctx.font='14px Inter'; ctx.textAlign='center';
      [[-90,'User'],[30,'Visual'],[150,'Story']].forEach(([a,l])=>{
        ctx.fillText(l, cx+Math.cos(toRad(a))*(R+16), cy+Math.sin(toRad(a))*(R+16));
      });
    }

    function quickWinsFromScores(scores, scopeLabel){
      const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
      const lensAvg = {
        user:   avg(Object.values(scores.user)),
        visual: avg(Object.values(scores.visual)),
        story:  avg(Object.values(scores.story)),
      };
      const ordered = Object.entries(lensAvg).sort((a,b)=>a[1]-b[1]).map(([k])=>k).slice(0,2);
      const wins = [];
      for(const lens of ordered){
        if(lens==='user') wins.push({title:`Clarify next steps on ${scopeLabel||'this page'}`, tip:'Add a single primary CTA above the fold and repeat it near the footer. Use a clear verb (Book a call, Get a quote).'});
        if(lens==='visual') wins.push({title:`Tighten visual consistency on ${scopeLabel||'this page'}`, tip:'Limit colors to 1â€“2 accents, unify button styles, and increase spacing between sections to reduce noise.'});
        if(lens==='story') wins.push({title:`State the value in plain words on ${scopeLabel||'this page'}`, tip:'Replace jargon with a one-sentence promise and add one proof point (metric, client name, or outcome).'});
      }
      return wins;
    }

    // ---------- image analysis (Safari-safe)
    async function loadBitmapCompat(file){
      if('createImageBitmap' in window) return await createImageBitmap(file);
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = e => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }
    function analyzeBitmapCompat(img){
      const cnv = document.createElement('canvas');
      const w = 640, h = Math.round(img.height * (w / img.width));
      cnv.width = w; cnv.height = h;
      const ctx = cnv.getContext('2d', { willReadFrequently:true });
      ctx.drawImage(img, 0, 0, w, h);
      const data = ctx.getImageData(0,0,w,h).data;
      let edges=0, colors=new Set(), brightSum=0, total=w*h;
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2];
        const y=(0.2126*r+0.7152*g+0.0722*b)/255; brightSum += y;
        colors.add(((r>>4)<<8)|((g>>4)<<4)|(b>>4));
        if(i>4){
          const pr=data[i-4], pg=data[i-3], pb=data[i-2];
          const py=(0.2126*pr+0.7152*pg+0.0722*pb)/255;
          if(Math.abs(y-py)>0.25) edges++;
        }
      }
      return { edge: edges/total, colors: Math.min(1, colors.size/4096), bright: brightSum/total };
    }
    async function getClientMetrics(fileList){
      const files = Array.from(fileList || []).slice(0,3);
      if(files.length===0) return null;
      const bitmaps = await Promise.all(files.map(loadBitmapCompat));
      const metrics = bitmaps.map(analyzeBitmapCompat);
      const avg = k => metrics.reduce((a,m)=>a+m[k],0)/metrics.length;
      const edge = avg('edge'), colors = avg('colors'), bright = avg('bright');
      return {
        visualConsistency: clamp01(1 - (colors*0.4 + edge*0.6)),
        visualTone: clamp01(bright),
        visualEnvironment: 0.5,
        storyEmotion: clamp01(0.3 + (1-edge)*0.4),
        storyIdentity: clamp01(0.3 + (1-colors)*0.5)
      };
    }

    // ---------- UI wire-up
    const contextEl = document.getElementById('context');
    const scopeEl   = document.getElementById('scope');
    const urlEl     = document.getElementById('url');
    const shotsEl   = document.getElementById('shots');
    const out       = document.getElementById('out');
    const msg       = document.getElementById('msg');
    const demoBtn   = document.getElementById('demo');
    const runBtn    = document.getElementById('run');

    demoBtn.onclick = () => { urlEl.value = 'https://example.com'; scopeEl.value = 'Homepage'; };

    let current = null; // will hold {scores, questions}

    runBtn.onclick = async () => {
      msg.textContent = 'Running analysisâ€¦'; msg.classList.remove('error');
      try {
        const cm = await getClientMetrics(shotsEl.files);
        const payload = {
          url: urlEl.value.trim(),
          context: contextEl.value,
          scopeLabel: scopeEl.value.trim(),
          clientMetrics: cm
        };
        const r = await fetch('/api/analyze', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const data = await r.json();
        if (data.error) throw new Error(data.error);

        // prepare questions with scope insertion
        const qs = QUESTIONS[contextEl.value].map(q => ({
          label: q.label.replace('{scope}', scopeEl.value || 'this page'),
          helper: q.helper
        }));

        // map API -> array order (1..9)
        const s = data.scores;
        const vals = [
          s.user.offer, s.user.navigation, s.user.action,
          s.visual.consistency, s.visual.tone, s.visual.environment,
          s.story.purpose, s.story.emotion, s.story.identity
        ];

        current = { scores: JSON.parse(JSON.stringify(s)), questions: qs, scope: scopeEl.value };

        // render
        renderRadar('radar', s);
        renderSummaryAndWins(s, scopeEl.value);
        renderScoresUI(qs, vals);
        out.classList.remove('hidden');
        msg.textContent = 'Done.';
      } catch (err) {
        console.error(err);
        msg.textContent = 'Error: ' + (err.message || 'Analysis failed');
        msg.classList.add('error');
      }
    };

    function overallAverage(scores){
      const all = [
        ...Object.values(scores.user),
        ...Object.values(scores.visual),
        ...Object.values(scores.story),
      ];
      return (all.reduce((a,b)=>a+b,0)/all.length).toFixed(1);
    }

    function renderSummaryAndWins(scores, scopeLabel){
      document.getElementById('summary').innerHTML =
        `Overall clarity: <span class="pill">${overallAverage(scores)} / 5</span> &nbsp;&nbsp; Evaluating: <span class="pill">${scopeLabel || 'this page'}</span>`;

      const winsWrap = document.getElementById('wins');
      winsWrap.innerHTML = '';
      const wins = quickWinsFromScores(scores, scopeLabel);
      wins.forEach(w => {
        const d = document.createElement('div');
        d.className = 'quickwin';
        d.innerHTML = `<strong>${w.title}</strong><br><span class="muted">${w.tip}</span>`;
        winsWrap.appendChild(d);
      });
    }

    function renderScoresUI(qs, vals){
      const wrap = document.getElementById('scoresUI');
      wrap.innerHTML = '';

      const mkBlock = (title, explain) => {
        const d = document.createElement('div');
        d.className = 'section';
        d.innerHTML = `<h3>${title}</h3><p class="explain">${explain}</p>`;
        return d;
      };

      // User block
      const bUser = mkBlock('ðŸŸ§ User Clarity', 'How easily a visitor understands what this is, finds what they need, and knows what to do next.');
      for(let i=0;i<3;i++) bUser.appendChild(row(i, qs[i], vals[i]));
      wrap.appendChild(bUser);

      // Visual block
      const bVisual = mkBlock('ðŸŸ¦ Visual Clarity', 'Cohesion, polish, and a calm, trustworthy feel.');
      for(let i=3;i<6;i++) bVisual.appendChild(row(i, qs[i], vals[i]));
      wrap.appendChild(bVisual);

      // Story block
      const bStory = mkBlock('ðŸŸ© Story Clarity', 'Purpose, emotion, and distinct identity coming through.');
      for(let i=6;i<9;i++) bStory.appendChild(row(i, qs[i], vals[i]));
      wrap.appendChild(bStory);
    }

    function row(idx, q, val){
      const div = document.createElement('div');
      div.className = 'score-row';
      div.innerHTML = `
        <div>
          <div class="q">${idx+1}. ${q.label}</div>
          <div class="muted" style="font-size:12px">${q.helper}</div>
        </div>
        <input class="range" type="range" min="1" max="5" step="1" value="${val}" data-idx="${idx}">
        <div><span class="pill" id="pill-${idx}">${val}/5</span></div>
      `;
      const slider = div.querySelector('.range');
      slider.addEventListener('input', (e)=>{
        const v = Number(e.target.value);
        div.querySelector(`#pill-${idx}`).textContent = `${v}/5`;
        // write back into current.scores
        if (!current) return;
        const map = [
          ['user','offer'], ['user','navigation'], ['user','action'],
          ['visual','consistency'], ['visual','tone'], ['visual','environment'],
          ['story','purpose'], ['story','emotion'], ['story','identity']
        ];
        const [lens, key] = map[idx];
        current.scores[lens][key] = v;
        renderRadar('radar', current.scores);
        renderSummaryAndWins(current.scores, current.scope);
      });
      return div;
    }
  </script>
</body>
</html>
